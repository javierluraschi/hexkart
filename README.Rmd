---
title: "hexkart: Kart simulation for model training"
output:
  github_document:
    fig_width: 9
    fig_height: 5
---

## Getting Started

Clone this GitHub repo and open the package project in RStudio, then launch this 
simulation running as a `htmlwidget` as follows:

```{r eval=FALSE}
library(hexkart)
hexkart_play()
```

![](tools/README/kart-demo.gif)

To capture a kart session simply run:

```{r eval=FALSE}
hexkart_capture()
```

This will create a snapshot under `capture/` with labels: `left-###.png`,
`right-###.png` or `forward-###.png`.

Once the session is captured, we can train a TensorFlow model by using:

```{r eval=FALSE}
tfruns::training_run("models/tensorflow.R")
```

or in `cloudml` runnning:

```{r eval=FALSE}
cloudml::cloudml_train("models/tensorflow.R")
```

use `tfdeploy` to validate that predictions over the trained model work by running:

```{r}
tfdeploy::predict_savedmodel(array(0, c(32,32,3)))
```

Notice that `predict_savedmodel()` initializes a tensorflow session for each
prediction, which takes too long:

```{r}
system.time(tfdeploy::predict_savedmodel(array(0, c(32,32,3))))
```

Instead, we can preload the model and predict over a `graph` object as follows:

```{r}
sess <- tensorflow::tf$Session()
graph <- tfdeploy::load_savedmodel(sess)

system.time(tfdeploy::predict_savedmodel(array(0, c(32,32,3)), graph, type = "graph", sess = sess))
```

Which we can use to control the kart based on this model:

```{r}
labels <- c("left", "forward", "right")
hexkart::hexkart_control(function(image, direction) {
  input <- array(png::readPNG(raw), c(32,32,3))
  result <- tfdeploy::predict_savedmodel(input, graph, type = "graph", sess = sess)
  scores <- result$predictions$output[[1]]
  labels[which(scores == max(scores))]
})
```